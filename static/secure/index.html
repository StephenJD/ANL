<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Auth0 Baseline with Switch</title>
<script src="https://cdn.auth0.com/js/auth0-spa-js/2.1.2/auth0-spa-js.production.js"></script>
</head>
<body>
<div id="status">Checking authentication...</div>
<button id="loginBtn">Login</button>
<button id="logoutBtn">Logout</button>
<pre id="debug"></pre>

<script>
const statusDiv = document.getElementById('status');
const loginBtn = document.getElementById('loginBtn');
const logoutBtn = document.getElementById('logoutBtn');
const debug = document.getElementById('debug');

function log(msg, obj){ debug.textContent += msg + (obj ? ': ' + JSON.stringify(obj,null,2) : '') + '\n'; }

// ==== SWITCH: show both buttons always for testing/debugging ====
const alwaysShowButtons = true;

window.onload = async () => {
  const client = await auth0.createAuth0Client({
    domain: "dev-5lsalv0spwawvbl7.uk.auth0.com",
    client_id: "8FJRW4DzlhHnnUGSbRkF8StwIxQ4zBzf",
    useFormData: true,
    cacheLocation: "memory",
    authorizationParams: {
      redirect_uri: window.location.origin + "/secure/index.html",
      audience: "https://ascendnextlevel.org.uk",
      scope: "openid profile email",
      client_id: "8FJRW4DzlhHnnUGSbRkF8StwIxQ4zBzf"
    }
  });

  // Handle redirect callback if present
  if (window.location.search.includes("code=") && window.location.search.includes("state=")) {
    try {
      log("Login redirect detected", {query: window.location.search});
      await client.handleRedirectCallback();
      window.history.replaceState({}, document.title, "/secure/index.html");
    } catch(err) {
      log("Error handling redirect callback", err);
    }
  }

  // Check auth status
  let isAuth = false;
  try { isAuth = await client.isAuthenticated(); } catch(e){ log("Auth check error", e); }

  statusDiv.textContent = isAuth ? "Status: Logged in" : "Status: Logged out";

  // BUTTON VISIBILITY LOGIC
  if (alwaysShowButtons) {
    loginBtn.style.display = "inline-block";
    logoutBtn.style.display = "inline-block";
  } else {
    loginBtn.style.display = isAuth ? "none" : "inline-block";
    logoutBtn.style.display = isAuth ? "inline-block" : "none";
  }

  // BUTTON HANDLERS
  loginBtn.onclick = async () => {
    try { await client.loginWithRedirect(); } catch(e){ log("loginWithRedirect error", e); }
  };

  logoutBtn.onclick = async () => {
    const returnTo = window.location.origin + "/secure/index.html";
    window.location.href = `https://${client.options.domain}/v2/logout?returnTo=${encodeURIComponent(returnTo)}&client_id=${client.options.client_id}`;
  };
};
</script>
</body>
</html>
