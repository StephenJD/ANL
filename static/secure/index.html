<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Auth0 Test</title>
<script src="https://cdn.auth0.com/js/auth0-spa-js/2.1.2/auth0-spa-js.production.js"></script>
</head>
<body>
  <pre id="debug">Loading...\n</pre>
  <button id="loginBtn">Login</button>

 <script>
const pre = document.getElementById('debug');
function logDebug(msg, obj) {
  pre.textContent += msg + ': ' + (obj ? JSON.stringify(obj, null, 2) : '') + '\n';
  console.log(msg, obj);
}

window.onload = async () => {
  logDebug('Document loaded');

  if (!window.auth0) {
    logDebug('FATAL: Auth0 global not found');
    return;
  }

  let client;
  try {
    logDebug('Creating Auth0 client...');
client = await auth0.createAuth0Client({
  domain: "dev-5lsalv0spwawvbl7.uk.auth0.com",
  client_id: "8FJRW4DzlhHnnUGSbRkF8StwIxQ4zBzf",
  useFormData: true,
  authorizationParams: {
    scope: "openid profile email",
    audience: "https://ascendnextlevel.org.uk",
    redirect_uri: window.location.origin + "/secure/index.html",
    client_id: "8FJRW4DzlhHnnUGSbRkF8StwIxQ4zBzf"  // <-- explicit
  }
});
    logDebug('Auth0 client created', client);
  } catch (err) {
    logDebug('FATAL ERROR creating client', err);
    return;
  }

  // Check if returning from login redirect
  if (window.location.search.includes('code=') && window.location.search.includes('state=')) {
    logDebug('Step: Handling redirect callback...');
    try {
      const result = await client.handleRedirectCallback();
      logDebug('Redirect callback result', result);
      // Remove query string after processing
      window.history.replaceState({}, document.title, "/secure/index.html");
    } catch (err) {
      logDebug('Error handling redirect callback', err);
    }
  }

  const isAuth = await client.isAuthenticated();
  logDebug('Step 2: isAuthenticated', isAuth);

  if (isAuth) {
    try {
      const user = await client.getUser();
      logDebug('Step 3: Authenticated user info', user);
      const token = await client.getTokenSilently();
      logDebug('Access token', token);
    } catch (err) {
      logDebug('Error fetching user/token', err);
    }
  } else {
    logDebug('Step 3: Not authenticated yet, user will login manually...');
    document.getElementById('loginBtn').onclick = async () => {
      try {
        logDebug('Step 4: Calling loginWithRedirect...');
        await client.loginWithRedirect();
      } catch (err) {
        logDebug('Step 5: loginWithRedirect error', err);
      }
    };
  }
};
</script>
</html>