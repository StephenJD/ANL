<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Auth0 SPA Debug Baseline</title>
  <script id="auth0script" src="https://cdn.auth0.com/js/auth0-spa-js/2.1.2/auth0-spa-js.production.js"></script>
  <style>
    #loginBtn, #logoutBtn { margin: 5px; }
    #status { font-weight: bold; margin-bottom: 10px; }
    pre { white-space: pre-wrap; word-wrap: break-word; }
  </style>
</head>
<body>
  <div id="status">Status: checking...</div>
  <button id="loginBtn">Login</button>
  <button id="logoutBtn">Logout</button>
  <pre id="debug"></pre>

<script>
const pre = document.getElementById('debug');
const statusDiv = document.getElementById('status');

// Toggle for testing: leave both buttons showing
const showBothButtons = true;

function logDebug(msg, obj) {
  pre.textContent += msg + (obj ? ": " + JSON.stringify(obj, null, 2) : "") + "\n";
  console.log(msg, obj);
}

function logFailureContext(client) {
  const scriptTag = document.getElementById('auth0script');
  const scriptSrc = scriptTag ? scriptTag.src : "(no src)";
  const versionMatch = scriptSrc.match(/auth0-spa-js\/([^/]+)/);
  const sdkVersion = versionMatch ? versionMatch[1] : "(unknown version)";
  const clientConfig = client ? client.options : {
    domain: "dev-5lsalv0spwawvbl7.uk.auth0.com",
    client_id: "8FJRW4DzlhHnnUGSbRkF8StwIxQ4zBzf",
    audience: "https://ascendnextlevel.org.uk",
    redirect_uri: window.location.origin + "/secure/index.html"
  };

  logDebug("FATAL: Auth0 SPA SDK failure context", {
    script: scriptSrc,
    version: sdkVersion,
    clientConfig: clientConfig
  });
}

window.onload = async () => {
  if (!window.auth0) {
    logFailureContext();
    logDebug("FATAL: Auth0 global not found");
    statusDiv.textContent = "Status: Auth0 SDK missing";
    return;
  }

  let client;
  try {
    client = await auth0.createAuth0Client({
      domain: "dev-5lsalv0spwawvbl7.uk.auth0.com",
      client_id: "8FJRW4DzlhHnnUGSbRkF8StwIxQ4zBzf",
      useFormData: true,
      cacheLocation: "localstorage",
      authorizationParams: {
        scope: "openid profile email",
        audience: "https://ascendnextlevel.org.uk",
        redirect_uri: window.location.origin + "/secure/index.html",
        client_id: "8FJRW4DzlhHnnUGSbRkF8StwIxQ4zBzf"
      }
    });
  } catch (err) {
    logFailureContext();
    logDebug("FATAL ERROR creating Auth0 client", err);
    statusDiv.textContent = "Status: Error creating Auth0 client";
    return;
  }

  // ===== HANDLE REDIRECT CALLBACK FIRST =====
  if (window.location.search.includes('code=') && window.location.search.includes('state=')) {
    logDebug("Login redirect detected", { query: window.location.search });
    try {
      await client.handleRedirectCallback();
      window.history.replaceState({}, document.title, "/secure/index.html");
    } catch (err) {
      logFailureContext(client);
      logDebug("Error handling redirect callback", err);
    }
  }

  // ===== CHECK AUTHENTICATION STATUS =====
  let isAuth = false;
  try {
    isAuth = await client.isAuthenticated();
    statusDiv.textContent = isAuth ? "Status: Logged in" : "Status: Logged out";
  } catch (err) {
    logFailureContext(client);
    logDebug("Error checking authentication", err);
    statusDiv.textContent = "Status: Error checking authentication";
  }

  // ===== SHOW/HIDE BUTTONS =====
  document.getElementById('loginBtn').style.display =
    showBothButtons || !isAuth ? "inline-block" : "none";
  document.getElementById('logoutBtn').style.display =
    showBothButtons || isAuth ? "inline-block" : "none";

  // ===== BUTTON HANDLERS =====
  document.getElementById('loginBtn').onclick = async () => {
    try {
      await client.loginWithRedirect();
    } catch (err) {
      logFailureContext(client);
      logDebug("loginWithRedirect error", err);
    }
  };

  document.getElementById('logoutBtn').onclick = async () => {
    try {
      const returnTo = window.location.origin + "/secure/index.html";
      window.location.href =
        `https://${client.options.domain}/v2/logout?returnTo=${encodeURIComponent(returnTo)}&client_id=${client.options.client_id}`;
    } catch (err) {
      logFailureContext(client);
      logDebug("Logout error", err);
    }
  };
};
</script>
</body>
</html>
