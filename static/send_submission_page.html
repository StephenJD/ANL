<-- \static\send_submission_page.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Final Form Submission</title>
</head>
<body>
  <p id="status">Submitting...</p>
<script>
  (async () => {
    const params = new URLSearchParams(window.location.search);
    const token = params.get('token');
    let validationMode = params.get('validationMode') || 'none';
  
    if (typeof validationMode === 'string') {
      validationMode = validationMode.split('#')[0].trim().split(/[\s,;]+/).filter(Boolean);
    }
  
    const requireFinalSubmit = validationMode.includes('submit');
    const status = document.getElementById('status');
  
    console.log('[DEBUG] token:', token);
    console.log('[DEBUG] validationMode:', validationMode);
    console.log('[DEBUG] requireFinalSubmit:', requireFinalSubmit);
  
    try {
      if (requireFinalSubmit) {
        if (!token) {
          status.textContent = 'Invalid or missing token.';
          return;
        }
  
        const verifyResp = await fetch('/.netlify/functions/verifyFinalToken', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ token })
        });
  
        if (!verifyResp.ok) throw new Error('verifyFinalToken ' + verifyResp.status);
        const data = await verifyResp.json();
  
        if (!data.valid) {
          status.textContent = 'This submission link has expired or is invalid.';
          return;
        }
      }
  
      const finalResp = await fetch('/.netlify/functions/finalSubmit', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ token: token || null })
      });
  
      if (!finalResp.ok) throw new Error('finalSubmit ' + finalResp.status);
      const finalData = await finalResp.json();
  
      status.textContent = finalData.success
        ? '✅ Your form has been successfully submitted!'
        : '❌ Submission failed. Please try again.';
    } catch (err) {
      console.error('[DEBUG]', err);
      status.textContent = 'Error verifying or submitting form.';
    }
  })();
</script>
</body>
</html>
