<!-- Client-Side: /static/send_submission_page.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Final Form Submission</title>
  <link rel="stylesheet" href="/css/forms.css">
</head>
<body class="submission-wrapper">
  <div class="form-request-box">
    <h1 id="status" class="form-status">Submitting...</h1>
  </div>
  <script>
  (async () => {
    const status = document.getElementById("status");
    const token = new URLSearchParams(window.location.search).get("token");

    console.log("[DEBUG] send_submission_page.html loaded");
    console.log("[DEBUG] URL:", window.location.href);
    console.log("[DEBUG] Extracted token:", token ? token : "(none)");

    if (!token) {
      status.textContent = "❌ Missing token in URL.";
      status.className = "error-message";
      console.error("[ERROR] No token provided in query string");
      return;
    }

    try {
      console.log("[DEBUG] Sending POST to /.netlify/functions/finalSubmit with token");
      const payload = { token };
      console.log("[DEBUG] Request body:", payload);

      const resp = await fetch("/.netlify/functions/finalSubmit", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      console.log("[DEBUG] Response status:", resp.status, resp.statusText);
      const rawText = await resp.text();
      console.log("[DEBUG] Raw response text:", rawText);

      let data;
      try {
        data = JSON.parse(rawText);
      } catch (parseErr) {
        console.error("[ERROR] Failed to parse JSON:", parseErr, "Raw:", rawText);
        status.textContent = "❌ Invalid JSON response from server.";
        status.className = "error-message";
        return;
      }

      if (data.success) {
        status.textContent = "✅ Form successfully submitted!";
        if (data.note) status.textContent += " " + data.note;
        status.className = "success-message";
        console.log("[DEBUG] finalSubmit success response:", data);
      } else {
        const errMsg = data.error || "unknown error";
        status.textContent = "❌ Submission failed: " + errMsg;
        status.className = "error-message";
        console.error("[ERROR] finalSubmit returned failure:", { status: resp.status, errMsg, data });
      }
    } catch (err) {
      console.error("[ERROR] Network or fetch failure:", err);
      status.textContent = "❌ Network error submitting form.";
      status.className = "error-message";
    }
  })();
  </script>
</body>
</html>
