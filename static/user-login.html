<!-- static/user-login.html -->

<div class="login-container">
  <h1>Login</h1>
  <form id="login-form" autocomplete="off">
    <label>User name:<input type="text" id="username" required></label>
    <label>Password:<input type="password" id="password" required></label>
    <button type="submit">Login</button>
  </form>
  <div id="login-message" style="color:red; margin-top:0.5em;"></div>
</div>

<script type="module">
const form = document.getElementById("login-form");
const message = document.getElementById("login-message");

form.addEventListener("submit", async e => {
  e.preventDefault();
  message.textContent = "";

  const userName = document.getElementById("username").value.trim();
  const password = document.getElementById("password").value;

  if (!userName || !password) {
    message.textContent = "Please fill all required fields.";
    return;
  }

  try {
    const resp = await fetch("/.netlify/functions/verifyUser", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ action: "getLogin_SessionToken", userName, password })
    });

    const data = await resp.json();

if (data.status !== "success") {
  message.textContent = `Login failed: ${data.status || data.error}`;
  return;
}

// Save token and user info
localStorage.setItem("session_key", data.sessionKey);
localStorage.setItem("user_role", data.role);

    // Redirect to the page specified in ?redirect= or to site root
    const redirect = new URLSearchParams(window.location.search).get("redirect") || "/";
    window.location.href = redirect;
  } catch (err) {
    console.error(err);
    message.textContent = "Login failed. Check console for details.";
  }
});
</script>
