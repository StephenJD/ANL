{{/* layouts/partials/anl_section_collation.html */}}

{{ $current_page := . }}
{{ $rawAccess := $current_page.Params.access | default "public" }}
{{ $content := $current_page.Content }}

{{ $access := slice }}
{{ range (split (printf "%v" $rawAccess) ",") }}
  {{ $clean := trim . " " }}
  {{ if $clean }}
    {{ $access = $access | append (lower $clean) }}
  {{ end }}
{{ end }}

<div class="debug-message">
  DEBUG: partials\anl_section_collation.html is running
  | Type={{ $current_page.Type }}
  | Section={{ $current_page.Section }}
  | Layout={{ $current_page.Layout }}
  | RawAccess={{ $rawAccess }}
  | Params.access={{ $current_page.Params.access | default "not set" }}
  | .Content length={{ len $current_page.Content }}
  | File.Path={{ .File.Path }}
</div>

<link rel="stylesheet" href="{{ "css/documents.css" | relURL }}">

{{/* <div> Opened in this parial */}}
{{ partial "anl_page_chrome.html" . }} 
  
  <section id="main-content" class="document-content">
    {{ if not (in $access "public") }}
      <div class="gated_page_placeholder" data-path="{{ .File.Path }}">
        <div class="page_access_message">Loading page…</div>
      </div>
    {{ else }}
      {{ if $content }}
        {{ $content | safeHTML }}
      {{ end }}

    {{ end }}
  </section>
  
  {{ $currentDir := $current_page.File.Dir }}
  {{ $all := where site.RegularPages "File.Dir" $currentDir }}
  {{ $sections := slice }}
  {{ range $all }}
    {{ if ne .File.Path $current_page.File.Path }}
      {{ $sections = $sections | append . }}
    {{ end }}
  {{ end }}
  {{ $sections = sort $sections "File.BaseFileName" }}
  
  <div class="debug-message">
    DEBUG: $current_page.Path={{ printf "%q" $current_page.File.Path }} |
           Dir={{ printf "%q" $currentDir }} |
           Section={{ printf "%q" $current_page.Section }} |
           Kind={{ printf "%q" $current_page.Kind }}
    DEBUG: sections count = {{ len $sections }}
    {{ range $sections }}
      {{ printf "  [SORTED] %q\n" .File.Path }}
    {{ end }}
  </div>

  {{ range $sections }}
    <section id="{{ .File.BaseFileName }}" class="document-content">
      <h2>{{ .Title }}</h2>
      {{/* Clean access frontmatter into lowercase slice */}}
      {{ $sectionAccess := slice }}
      {{ range (split (printf "%v" (.Params.access | default "public")) ",") }}
        {{ $clean := trim . " " }}
        {{ if $clean }}{{ $sectionAccess = $sectionAccess | append (lower $clean) }}{{ end }}
      {{ end }}
  
      {{ if not (in $sectionAccess "public") }}
        <div class="gated_page_placeholder" data-path="{{ .File.Path }}">
          <div class="page_access_message">Loading page…</div>
        </div>
      {{ else }}
        {{ if .Content }}
          {{ .Content | safeHTML }}
        {{ else }}
          {{ .Render "main" }}
        {{ end }}
      {{ end }}
    </section>
  {{ end }}
</div>

<script type="module">
import { loadGatedPage } from "{{ "js/gated_page_loader.js" | relURL }}";

document.addEventListener("DOMContentLoaded", () => {
  const token = localStorage.getItem("userLogin_token");
  const placeholders = document.querySelectorAll(".gated_page_placeholder");

  placeholders.forEach(p => {
    const pagePath = p.dataset.path;

    if (p.closest("#main-content")) {
      loadGatedPage(p, pagePath, p.querySelector(".page_access_message"));
      console.log("DEBUG: loading gated main page:", pagePath);
    } else {
      if (token) {
        loadGatedPage(p, pagePath, p.querySelector(".page_access_message"));
        console.log("DEBUG: loading gated nested section:", pagePath);
      } else {
        console.log("DEBUG: gated section skipped (not logged in):", pagePath);
        const msgBox = p.querySelector(".page_access_message");
        if (msgBox) {
          msgBox.textContent = "Log in to see this content";
          msgBox.style.display = "block";
        }
      }
    }
  });
});
</script>
