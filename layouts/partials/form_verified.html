<!-- Email request box -->
<div class="form-request-box">
  <p>Enter your email to enable the form:v10</p>
  <input type="email" class="request-email" placeholder="Your email" required>
  <button type="button" class="request-token-btn">Request Link</button>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const form = document.querySelector('form.verified-form');
  const requestBox = document.querySelector('.form-request-box');
  const btn = requestBox.querySelector('.request-token-btn');
  const emailInput = requestBox.querySelector('.request-email');

  if (!form || !btn || !emailInput) {
    console.error('Form, button, or email input not found.');
    return;
  }

  // Disable all fields initially
  form.querySelectorAll('input, textarea, select, button[type="submit"]').forEach(el => el.disabled = true);

  btn.addEventListener('click', async () => {
    const email = emailInput.value.trim();
    if (!email) {
      alert("Enter your email first");
      return;
    }

    try {
      const resp = await fetch("/.netlify/functions/generateToken", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email, formId: form.getAttribute('name') })
      });

      const data = await resp.json();

      if (data.success) {
        alert("Check your email for the link.");
      } else {
        alert("Error sending link: " + (data.error || "unknown error"));
      }
    } catch (err) {
      console.error(err);
      alert("Request failed");
    }
  });
});
</script>
