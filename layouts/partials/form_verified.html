<!-- layouts/partials/form_verified.html -->
<div class="form-request-box">
  <p>Enter your email to enable the form:</p>
  <input type="email" class="request-email" placeholder="Your email" required>
  <button type="button" class="request-token-btn">Request Link</button>
  <div class="token-message" style="color:red;margin-top:0.5em;"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', async () => {
  const form = document.querySelector('form.verified-form');
  const requestBox = document.querySelector('.form-request-box');
  if (!form || !requestBox) return;

  const messageBox = requestBox.querySelector('.token-message');
  const btn = requestBox.querySelector('.request-token-btn');
  const emailInput = requestBox.querySelector('.request-email');

  // Disable form inputs initially
  form.querySelectorAll('input, textarea, select, button[type="submit"]').forEach(el => el.disabled = true);

  // Autofill date fields
  document.querySelectorAll('input[type="date"].autofill-today').forEach(input => {
    input.valueAsDate = new Date();
  });

  // Request link button
  btn.addEventListener('click', async () => {
    const email = emailInput.value.trim();
    if (!email) { alert("Enter your email first"); return; }

    try {
      const resp = await fetch("/.netlify/functions/sendFormAccessLink", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          email,
          formPath: window.location.pathname,
          formName: document.querySelector('form.verified-form').name || document.title,
          site_root: window.location.origin
        })
      });
      const data = await resp.json();
      alert(data.success ? "Check your email for the link." : "Error sending link: " + (data.error || "unknown error"));
    } catch (err) {
      console.error(err);
      alert("Request failed");
    }
  });

  // Token verification
  const params = new URLSearchParams(window.location.search);
  const token = params.get('token');
  const email = params.get('email');
  const formPath = window.location.pathname;

  if (token && email) {
    try {
      const resp = await fetch("/.netlify/functions/verifySecureToken", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ token, email, formPath })
      });
      const data = await resp.json();

      if (data.valid) {
        form.querySelectorAll('input, textarea, select, button[type="submit"]').forEach(el => el.disabled = false);
        requestBox.style.display = 'none';
        messageBox.style.display = 'none';
        console.log("Token valid, form enabled.");
      } else {
        messageBox.textContent = "Invalid link. It may have expired, or is for the wrong email/form.";
      }
    } catch (err) {
      console.error("Error verifying token:", err);
    }
  }

/* --- INLINE-FIT LABEL+INPUT LAYOUT (after paint) --- */
  function updateInlineFit() {
    const form = document.querySelector("form.verified-form");
    if (!form) return;
  
    const formWidth = form.offsetWidth;
  
    // All inputs and selects (exclude textareas)
    const allInputs = form.querySelectorAll("input, select");
  
    allInputs.forEach(inputElem => {
      const label = inputElem.previousElementSibling;
      const style = window.getComputedStyle(inputElem);
      if (style.display !== "inline-block") return; // only short inputs
      if (!label || label.tagName !== "LABEL") return;
  
      // Only use the input's width, ignore full label width
      const inputWidth = inputElem.getBoundingClientRect().width;
      if (inputWidth + 16 < formWidth) { // small margin allowance
        label.classList.add("inline-fit");
        inputElem.classList.add("inline-fit");
        //console.log("Added inline-fit:", label.textContent, inputElem.name);
      } else {
        label.classList.remove("inline-fit");
        inputElem.classList.remove("inline-fit");
        //console.log("Removed inline-fit:", label.textContent, inputElem.name);
      }
    });
  }  
  requestAnimationFrame(updateInlineFit);

  // Recalculate on load and resize
  window.addEventListener("load", updateInlineFit);
  window.addEventListener("resize", updateInlineFit);
});
</script>

<script type="module">
import { formatFormData } from '/js/formatFormData.js';

const form = document.querySelector('form.verified-form');

if (form) {
  form.addEventListener('submit', async (e) => {
    e.preventDefault(); // stop default submission

    // Get query params
    const params = new URLSearchParams(window.location.search);
    const token = params.get('token');
    const email = params.get('email');

    if (!token || !email) {
      alert("Missing token or email in URL. Cannot send formatted email.");
      return;
    }

    // Format form data
    const formattedForm = formatFormData(form);

    try {
      const resp = await fetch('/.netlify/functions/sendFormattedForm', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          email,
          token,
          formName: form.name || document.title,
          formattedForm,
          site_root: window.location.origin
        })
      });

      const data = await resp.json();
      if (data.success) {
        alert("Your form has been emailed to you for review. Please check your inbox.");
      } else {
        alert("Error sending email: " + (data.error || "unknown"));
      }
    } catch (err) {
      console.error(err);
      alert("Failed to send form email.");
    }
  });
}
</script>


<script type="module">
  // this just for console testing.
  import { formatFormData } from '/js/formatFormData.js';

  const form = document.querySelector('form.verified-form');
  if (form) {
    const formatted = formatFormData(form);
    console.log("Formatted HTML preview:\n", formatted);

    // Optional: preview on page
    const preview = document.createElement('div');
    preview.innerHTML = formatted;
    document.body.appendChild(preview);
  } else {
    console.warn('No verified-form found.');
  }
</script>

<form class="verified-form" name="Test Form">
  <fieldset>
    <legend>Your opinion</legend>
    <label><input type="radio" name="Idea" value="Good Idea"> Good Idea</label>
    <label><input type="radio" name="Idea" value="Bad Idea"> Bad Idea</label>
    <label for="idea_other">Other:</label>
    <textarea id="idea_other" name="Idea_Other"></textarea>
  </fieldset>
  <fieldset>
    <legend>Details</legend>
    <label for="firstName">First Name</label>
    <input type="text" id="firstName" name="Name" required>
  </fieldset>
  <button type="submit">Submit</button>
</form>

<script type="module">
import { formatFormData } from '/js/formatFormData.js';

const form = document.querySelector('form.verified-form');

// Fake URL query for testing
const fakeEmail = 'test@example.com';
const fakeToken = '12345';

form.addEventListener('submit', async (e) => {
  e.preventDefault();

  const formatted = formatFormData(form);
  console.log("=== Formatted form preview ===\n", formatted);

  // Simulate sending to Netlify function
  console.log("Simulating POST to sendFormattedForm with:");
  console.log({
    email: fakeEmail,
    token: fakeToken,
    formName: form.name,
    formattedForm: formatted,
    site_root: window.location.origin
  });

  alert("Check console for simulated formatted email output.");
});
</script>

