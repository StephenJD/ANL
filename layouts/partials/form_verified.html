<!-- partials/form_verified.html -->
<div class="form-request-box">
  <p>Enter your email to enable the form:</p>
  <input type="email" class="request-email" placeholder="Your email" required>
  <button type="button" class="request-token-btn">Request Link</button>
  <div class="token-message" style="color:red;margin-top:0.5em;"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const form = document.querySelector('form.verified-form');
  const requestBox = document.querySelector('.form-request-box');
  const messageBox = requestBox.querySelector('.token-message');
  
  if (!form || !requestBox) return;

  const btn = requestBox.querySelector('.request-token-btn');
  const emailInput = requestBox.querySelector('.request-email');

  form.querySelectorAll('input, textarea, select, button[type="submit"]').forEach(el => el.disabled = true);

  btn.addEventListener('click', async () => {
    const email = emailInput.value.trim();
    if (!email) { alert("Enter your email first"); return; }

    try {
      const resp = await fetch("/.netlify/functions/sendFormAccessLink", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          email,
          formPath: window.location.pathname,
          site_root: window.location.origin
        })
      });
      const data = await resp.json();
      if (data.success) {
        alert("Check your email for the link.");
      } else {
        alert("Error sending link: " + (data.error || "unknown error"));
      }
    } catch (err) {
      console.error(err);
      alert("Request failed");
    }
  });
});

document.addEventListener('DOMContentLoaded', async () => {
  const form = document.querySelector('form.verified-form');
  const requestBox = document.querySelector('.form-request-box');
  if (!form) return;

  const params = new URLSearchParams(window.location.search);
  const token = params.get('token');
  const email = params.get('email');
  const formPath = window.location.pathname; // <-- send formPath for validation

  if (token && email) {
    console.log("Token found in URL:", token);
    console.log("Email from URL:", email);
    console.log("Form path:", formPath);

    try {
      const resp = await fetch("/.netlify/functions/verifySecureToken", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ token, email, formPath })
      });
      const data = await resp.json();
      console.log("Token validation response JSON:", JSON.stringify(data));

      if (data.valid) {
        form.querySelectorAll('input, textarea, select, button[type="submit"]').forEach(el => el.disabled = false);
        if (requestBox) requestBox.style.display = 'none';
	  if (messageBox) messageBox.style.display = 'none'; // hides any previous error message
        console.log("Token is valid, enabling form...");
      } else {
        messageBox.textContent = "Invalid link. It may have expired (it must be used the same day it was emailed), or it is being used with the wrong the email address, or the wrong form is attempted.";
        console.log("Invalid token, form remains disabled");
      }

    } catch (err) {
      console.error("Error verifying token:", err);
    }
  }
});
</script>
