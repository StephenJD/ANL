<!-- Email request box -->
<div class="form-request-box">
  <p>Enter your email to enable the form: v3</p>
  <input type="email" class="request-email" placeholder="Your email" required>
  <button type="button" class="request-token-btn">Request Link</button>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  console.log("form_verified.js runningâ€¦");

  document.querySelectorAll("section.form-container").forEach(section => {
    const form = section.querySelector("form.verified-form");
    const requestBox = section.querySelector(".form-request-box");

    if (!form || !requestBox) {
      console.error("Missing form or requestBox in section", section);
      return;
    }

    console.log("Found form:", form.getAttribute("name"));

    const btn = requestBox.querySelector(".request-token-btn");
    const emailInput = requestBox.querySelector(".request-email");

    // Disable fields initially
    form.querySelectorAll("input, textarea, select, button[type='submit']").forEach(el => {
      el.disabled = true;
    });
    console.log("Form fields disabled");

    btn.addEventListener("click", async () => {
      const email = emailInput.value.trim();
      console.log("Button clicked, email entered:", email);
      if (!email) { alert("Enter your email first"); return; }

      try {
        const resp = await fetch("/.netlify/functions/generateToken", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, formId: form.getAttribute("name") })
        });

        const text = await resp.text();
        console.log("Raw response:", text);

        let data;
        try {
          data = JSON.parse(text);
        } catch (e) {
          console.error("Failed to parse JSON:", e, text);
          alert("Server returned invalid response.");
          return;
        }

        if (data.success) {
          alert("Check your email for the link.");
        } else {
          alert("Error sending link: " + (data.error || "unknown error"));
        }
      } catch (err) {
        console.error("Fetch failed:", err);
        alert("Request failed");
      }
    });
  });
});
</script>
