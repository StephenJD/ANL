{{/* layouts/_default/baseof.html */}}

<!DOCTYPE html>
{{- $language_code := site.LanguageCode | default "en-us" -}}
<html lang="{{$language_code}}" {{ if in site.Data.i18n.rtl.rtl $language_code }}dir="rtl"{{end}}>

{{ partial "site_head" . }}

{{ $show_navbar := site.Params.main_menu.enable | default true }}
{{- $highlight_active_link := site.Params.main_menu.highlight_active_link | default true -}}
<body id="top" data-spy="scroll" {{ if $show_navbar }}data-offset="70"{{end}} data-target="{{ if or .IsHome (eq .Type "widget_page") | and $highlight_active_link }}#navbar-main{{else}}#TableOfContents{{end}}" class="page-wrapper {{ if not (.Scratch.Get "light") }}dark{{end}} {{ if not $show_navbar }}no-navbar{{end}}">

  {{/* Initialise Wowchemy JS */}}
  {{ $js_license := printf "/*! Wowchemy v%s | https://wowchemy.com/ */\n" site.Data.wowchemy.version }}
  {{ $js_license = $js_license | printf "%s/*! Copyright 2016-present George Cushen (https://georgecushen.com/) */\n" }}
  {{ $js_license = $js_license | printf "%s/*! License: https://github.com/wowchemy/wowchemy-hugo-modules/blob/master/LICENSE.md */\n" }}
  {{ $js_bundle_head := $js_license | resources.FromString "js/bundle-head.js" }}
  {{ $wcDarkLightEnabled := site.Params.day_night | default false }}
  {{ $wcIsSiteThemeDark := not (.Scratch.Get "light") | default false }}
  {{ $js_params := dict "wcDarkLightEnabled" $wcDarkLightEnabled "wcIsSiteThemeDark" $wcIsSiteThemeDark }}
  {{ $js_bundle := resources.Get "js/wowchemy-init.js" | js.Build (dict "params" $js_params) }}
  {{- if eq hugo.Environment "production" -}}
    {{ $js_bundle = $js_bundle | minify }}
  {{- end -}}
  {{ $js_bundle = slice $js_bundle_head $js_bundle | resources.Concat "js/wowchemy-init.min.js" }}
  {{- if eq hugo.Environment "production" -}}
    {{- $js_bundle = $js_bundle | fingerprint "md5" -}}
  {{- end -}}
  <script src="{{ $js_bundle.RelPermalink }}"></script>

  {{ partial "search" . }}

  <div class="page-header">
    {{ partial "navbar" . }}
  </div>

  {{/* -------------------- PAGE BODY -------------------- */}}
  <div class="page-body">

  {{ $rawAccess := .Params.access | default "public" }}
  {{ $access := slice }}
  
  {{ if $rawAccess }}
    {{ range (split (printf "%v" $rawAccess) ",") }}
      {{ $clean := trim . " " }}
      {{ if $clean }}
        {{ $access = $access | append (lower $clean) }}
      {{ end }}
    {{ end }}
  {{ else }}
    {{ $access = slice "public" }}
  {{ end }}
  
  {{ $background_image := .Params.background_image }}
  {{ $logo_image := .Params.logo_image }}

<div style="background:#000;color:#0f0;padding:6px;font-size:12px;">
  DEBUG: anl_document_layout.html is running
  | Type={{ .Type }}
  | Section={{ .Section }}
  | Layout={{ .Layout }}
  | RawAccess={{ .Params.access }}
  | NormalizedAccess={{ delimit $access "," }}
  | Background={{ $background_image }}
  | logo={{ $logo_image }}
</div>

<link rel="stylesheet" href="{{ "css/documents.css" | relURL }}">
<div class="page-container" style="{{ if $background_image }}background-image: url('{{ $background_image }}'); background-size: cover; background-position: center;{{ end }}">

  {{ with $logo_image }}
    <div class="logo">
      <img src="{{ . }}" alt="Logo" style="max-width:300px;">
    </div>
  {{ end }}


  {{ partial "qr_code.html" . }}
  {{ partial "page_access_message.html" . }}
  
    <section id="main-content" class="document-content">
      {{ if not (in $access "public") }}
        <div class="gated-page-placeholder" data-path="{{ .RelPermalink }}">
          <div class="page_access_message">Loading page…</div>
        </div>
      {{ else }}
        {{/* Normal pages show .Content, _index.md or sections render "main" */}}
        {{ if .Content }}
          {{ .Content | safeHTML }}
        {{ else }}
          {{ .Render "main" }}
        {{ end }}
      {{ end }}
    </section>

    {{/* Include other resources in same folder (optional) */}}
    {{ $current_page := . }}
    {{ $sections := sort (.Resources.Match "*.md") "File.BaseFileName" }}
    {{ range $sections }}
      {{ if ne .File.Path $current_page.File.Path }}
        <section id="{{ .File.BaseFileName }}" class="document-content">
          <h2>{{ .Title }}</h2>
          {{ $sectionAccess := .Params.access | default (slice "public") }}
          {{ if not (in $sectionAccess "public") }}
            <div class="gated-page-placeholder" data-path="{{ .RelPermalink }}">
              <div class="page_access_message">Loading page…</div>
            </div>
          {{ else }}
            {{ if .Content }}
              {{ .Content | safeHTML }}
            {{ else }}
              {{ .Render "main" }}
            {{ end }}
          {{ end }}
        </section>
      {{ end }}
    {{ end }}

  </div>
</body>
</html>

<script type="module">
import { loadGatedPage } from "{{ "js/gated_page_loader.js" | relURL }}";

document.addEventListener("DOMContentLoaded", () => {
  const token = localStorage.getItem("userLogin_token");
  const placeholders = document.querySelectorAll(".gated-page-placeholder");

  placeholders.forEach(p => {
    const pagePath = p.dataset.path;

    if (p.closest("#main-content")) {
      loadGatedPage(p, pagePath, p.querySelector(".page_access_message"));
      console.log("DEBUG: loading gated main page:", pagePath);
    } else {
      if (token) {
        loadGatedPage(p, pagePath, p.querySelector(".page_access_message"));
        console.log("DEBUG: loading gated nested section:", pagePath);
      } else {
        const msgBox = p.querySelector(".page_access_message");
        if (msgBox) {
          msgBox.textContent = "Log in to see this content";
          msgBox.style.display = "block";
        }
      }
    }
  });
});
</script>
