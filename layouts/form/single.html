{{/* layouts/forms/single.html */}}
{{ define "main" }}
  <link rel="stylesheet" href="{{ "css/forms.css" | relURL }}">

  <div class="form-container">
    <h1>{{ .Title }}</h1>
    {{ partial "qr_code.html" . }}
    {{ partial "form_request.html" . }}
  
    <form name="{{ .Title | urlize }}" autocomplete="off" class="verified-form" data-netlify="true" netlify>
      {{ .Content }}
      {{ partial "form_submit_button.html" . }}
    </form>
    
    <script>
  // === Inline-fit layout ===
  function updateInlineFit() {
    const form = document.querySelector("form.verified-form");
    if (!form) return;

    const marginBuffer = 8;

function fitElements(elements) {
    // Only apply inline-fit to visible elements
    const visibleElements = elements.filter(el => el.offsetParent !== null);
    const totalWidth = visibleElements.reduce((sum, el) => sum + el.getBoundingClientRect().width + marginBuffer, 0);
    visibleElements.forEach(el => el.classList.toggle("inline-fit", totalWidth < form.offsetWidth));
  }
    // Inputs + labels
    form.querySelectorAll("input, select").forEach(input => {
      const label = input.previousElementSibling;
      if (label && label.tagName === "LABEL") fitElements([label, input]);
    });

    // Consecutive buttons
    const buttons = Array.from(form.querySelectorAll("button"));
    for (let i = 0; i < buttons.length; i++) {
      const row = [buttons[i]];
      let next = buttons[i].nextElementSibling;
      while (next && next.tagName === "BUTTON") {
        row.push(next);
        i++;
        next = next.nextElementSibling;
      }
      if (row.length > 1) fitElements(row);
    }
  }

  // === Mark fieldsets where all inputs are required ===
  function markAllRequiredFieldsets() {
    document.querySelectorAll("fieldset").forEach(fs => {
      const inputs = fs.querySelectorAll("input, textarea, select");
      const allRequired = Array.from(inputs).every(input => input.hasAttribute("required"));
      if (allRequired) fs.classList.add("all-required");
    });
  }

  // === Optional email display ===
  function enableOptionalEmail() {
    const form = document.querySelector("form.verified-form");
    if (!form) return;
  
    const optionalEmail = form.querySelector("#optionalEmail");
    const hasSubmittedBy = form.querySelector("#submitted_by") !== null;
  
    if (!hasSubmittedBy && optionalEmail) optionalEmail.style.display = "block";
  }

function renameRadioGroups() {
  const form = document.querySelector("form.verified-form");
  if (!form) return;

  let groupCounter = 0;

  form.querySelectorAll('fieldset').forEach(fs => {
    const labels = Array.from(fs.querySelectorAll('label'));
    let currentGroupRadios = [];

    labels.forEach((label, i) => {
      const radios = label.querySelectorAll('input[type="radio"]');

      if (radios.length) {
        // This label contains radios; collect them for current group
        currentGroupRadios.push(...radios);
      } else if (currentGroupRadios.length) {
        // Previous radios collected â€” assign them a name
        groupCounter++;
        currentGroupRadios.forEach(r => r.name = `r${groupCounter}`);
        currentGroupRadios = [];
      }
    });

    // Handle any remaining radios at the end
    if (currentGroupRadios.length) {
      groupCounter++;
      currentGroupRadios.forEach(r => r.name = `r${groupCounter}`);
    }
  });
}


  // === Date fields autocomplete off ===
  function disableDateAutocomplete() {
    const form = document.querySelector("form.verified-form");
    if (!form) return;
    form.querySelectorAll('input[type="date"]').forEach(input => input.setAttribute('autocomplete', 'off'));
  }

  // === Autofill today's date ===
  function autofillToday() {
    const form = document.querySelector("form.verified-form");
    if (!form) return;
    form.querySelectorAll('input[type="date"].autofill-today').forEach(input => { input.valueAsDate = new Date(); });
  }

  document.addEventListener("DOMContentLoaded", () => {
    enableOptionalEmail();
    updateInlineFit();
    markAllRequiredFieldsets();
    renameRadioGroups();
    disableDateAutocomplete();
    autofillToday();
  });

  window.addEventListener("resize", updateInlineFit);
</script>

    
    <script src="{{ "js/form_access_controller.js" | relURL }}" defer></script>
  </div>
{{ end }}
