{{/* layouts/forms/single.html */}}
{{ define "main" }}
  <!-- Load form-specific stylesheet -->
  <link rel="stylesheet" href="{{ "css/forms.css" | relURL }}">

  <div class="form-container">
    <h1>{{ .Title }}</h1>
    {{ partial "form_request.html" . }}
  
    <form name="{{ .Title | urlize }}" autocomplete="off" class="verified-form" data-netlify="true" netlify>
      {{ .Content }}   <!-- fieldsets only -->
      {{ partial "form_submit_button.html" . }}
    </form>
    
    <script>   
      // Inline-fit layout
      function updateInlineFit() {
        const form = document.querySelector("form.verified-form");
        if (!form) return;
        const formWidth = form.offsetWidth;
        const allInputs = form.querySelectorAll("input, select");
        allInputs.forEach(inputElem => {
          const label = inputElem.previousElementSibling;
          if (!label || label.tagName !== "LABEL") return;
          const inputWidth = inputElem.getBoundingClientRect().width;
          if (inputWidth + 16 < formWidth) {
            label.classList.add("inline-fit");
            inputElem.classList.add("inline-fit");
          } else {
            label.classList.remove("inline-fit");
            inputElem.classList.remove("inline-fit");
          }
        });
	  
        let radioGroupCounter = 0;
        form.querySelectorAll('fieldset').forEach(fs => {
          const radios = fs.querySelectorAll('input[type="radio"]');
          if (radios.length) {
            radioGroupCounter++;
            radios.forEach(r => r.name = `r${radioGroupCounter}`);
          }
        });
	  
        // Ensure date fields have autocomplete off
        form.querySelectorAll('input[type="date"]').forEach(input => {
          input.setAttribute('autocomplete', 'off');
        });

        // Autofill date fields 
        form.querySelectorAll('input[type="date"].autofill-today').forEach(input => { input.valueAsDate = new Date(); });
      }

      // Add star to legend if all inputs in fieldset are required
      function markAllRequiredFieldsets() {
        document.querySelectorAll("fieldset").forEach(fs => {
          const inputs = fs.querySelectorAll("input, textarea, select");
          const allRequired = Array.from(inputs).every(input => input.hasAttribute("required"));
          if (allRequired) fs.classList.add("all-required");
        });
      }

      function enableOptionalEmail() {
        const form = document.querySelector("form.verified-form");
        if (!form) return;
      
        const optionalEmail = form.querySelector("#optionalEmail");
        const hasSubmittedBy = form.querySelector("#submitted_by") !== null;
      
        if (!hasSubmittedBy && optionalEmail) {
          optionalEmail.style.display = "block";
        }	
	}
	
      document.addEventListener("DOMContentLoaded", () => {
	  enableOptionalEmail();
        updateInlineFit();
        markAllRequiredFieldsets();
      });

      window.addEventListener("resize", updateInlineFit);
    </script>
    
    <script src="{{ "js/form_access_controller.js" | relURL }}" defer></script>
  </div>
{{ end }}
