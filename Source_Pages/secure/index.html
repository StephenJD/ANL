<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Auth0 Cleaned Debug (+ token request interception)</title>
  <script src="https://cdn.auth0.com/js/auth0-spa-js/2.1.2/auth0-spa-js.production.js"></script>
  <style>
    body { font-family: system-ui, Arial; padding: 1rem; }
    #status { margin-bottom: .5rem; font-weight: bold; }
    #debug { white-space: pre-wrap; background:#111; color:#bfb; padding:12px; max-height:55vh; overflow:auto; }
    button { margin-right: .5rem; }
  </style>
</head>
<body>
  <div id="status">Status: ...</div>
  <button id="loginBtn">Login</button>
  <button id="logoutBtn">Logout</button>
  <pre id="debug"></pre>

<script>
const pre = document.getElementById('debug');
const statusDiv = document.getElementById('status');

// === CONFIG ===
const AUTH0_DOMAIN = "dev-5lsalv0spwawvbl7.uk.auth0.com";
const CLIENT_ID = "8FJRW4DzlhHnnUGSbRkF8StwIxQ4zBzf";
const AUDIENCE = "https://ascendnextlevel.org.uk";
const REDIRECT_PATH = "/secure/";

const authConfig = {
  domain: AUTH0_DOMAIN,
  client_id: CLIENT_ID,
  useFormData: true,
  cacheLocation: "localstorage",
  useRefreshTokens: true,
  authorizationParams: {
    redirect_uri: window.location.origin + REDIRECT_PATH,
    audience: AUDIENCE,
    scope: "openid profile email",
    client_id: CLIENT_ID
  }
};

// === Helpers ===
function append(msg, obj) {
  pre.textContent += msg + (obj ? ': ' + JSON.stringify(obj, null, 2) : '') + '\n';
  console.log(msg, obj || '');
}
function redactTokens(obj) {
  if (!obj || typeof obj !== 'object') return obj;
  const copy = Array.isArray(obj) ? [...obj] : {...obj};
  for (const k of Object.keys(copy)) {
    if (/token|id_token|access_token|refresh_token|client_secret/i.test(k)) {
      copy[k] = (typeof copy[k] === 'string') ? copy[k].slice(0,8)+'…' : copy[k];
    }
  }
  return copy;
}
function dumpEnvironment(label) {
  append(label, {
    localStorage_keys: Object.keys(localStorage),
    sessionStorage_keys: Object.keys(sessionStorage),
    cookies: document.cookie || "(none)"
  });
}
function clearStaleAuthStorage() {
  if (sessionStorage.getItem('auth0_first_login')) {
    sessionStorage.removeItem('auth0_first_login');
    localStorage.removeItem('a0.spajs.txs.undefined');
  }
}

// === Network interception for /oauth/token ===
(function() {
  const origFetch = window.fetch;
  window.fetch = async function(input, init) {
    const url = (typeof input === 'string') ? input : (input && input.url) || '';
    const isToken = url.includes('/oauth/token') && url.includes(AUTH0_DOMAIN);
    if (isToken) {
      let parsed = init && init.body ? {raw: init.body} : {};
      append("[NETWORK] fetch -> oauth/token request", { url, method: init && init.method, body_sample: redactTokens(parsed) });
    }
    const resp = await origFetch.apply(this, arguments);
    if (isToken) {
      let clone = resp.clone();
      try { 
        const json = await clone.json();
        append("[NETWORK] fetch <- oauth/token response", { url, status: resp.status, body: redactTokens(json) });
      } catch(e){ append("[NETWORK] fetch <- oauth/token response parse failed", { url, status: resp.status }); }
    }
    return resp;
  };
})();

// === Core Auth0 flow ===
window.onload = async () => {
  append("=== Auth0 init start ===");
  dumpEnvironment("Before Auth0 client creation");

  clearStaleAuthStorage();

  if (!window.auth0) { append("FATAL: Auth0 global not found"); return; }

  let client;
  try {
    client = await auth0.createAuth0Client(authConfig);
  } catch (err) {
    append("FATAL ERROR creating client", err && (err.message || err));
    return;
  }

  // Handle redirect callback if returned from login
  if (window.location.search.includes('code=') && window.location.search.includes('state=')) {
    append("Login redirect detected", { query: window.location.search });
    try {
      const result = await client.handleRedirectCallback();
      append("handleRedirectCallback result", redactTokens(result));
      window.history.replaceState({}, document.title, REDIRECT_PATH);
    } catch (err) {
      append("handleRedirectCallback returned empty error, ignoring", err || {});
    }
  }

  // Check authentication state
  let isAuth = false;
  try { isAuth = await client.isAuthenticated(); } catch(e) { append("Error checking auth", e); }

  if (isAuth) {
    try { const claims = await client.getIdTokenClaims(); append("getIdTokenClaims()", redactTokens(claims)); } catch(e){}
    try { const user = await client.getUser(); append("getUser()", redactTokens(user)); } catch(e){}
  }

  // Update UI
  statusDiv.textContent = "Status: " + (isAuth ? "Logged in" : "Logged out");
  document.getElementById('loginBtn').style.display = "inline-block";
  document.getElementById('logoutBtn').style.display = "inline-block";

  // Wire buttons
  document.getElementById('loginBtn').onclick = async () => {
    append("Login button clicked");
    try { await client.loginWithRedirect(); } catch (err) { append("loginWithRedirect error", err); }
  };
  document.getElementById('logoutBtn').onclick = () => {
    append("Logout button clicked");
    const returnTo = window.location.origin + REDIRECT_PATH;
    window.location.href = `https://${client.options.domain}/v2/logout?returnTo=${encodeURIComponent(returnTo)}&client_id=${client.options.client_id}`;
  };

  dumpEnvironment("Final environment dump");
  append("Auth0 init complete — UI ready");
};
</script>
</body>
</html>
